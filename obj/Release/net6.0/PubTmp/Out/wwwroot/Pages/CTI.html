<!DOCTYPE html>
<html>
<head>
    <title>CRM Dialer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/signalr.min.js"></script>
    <style>


        select, button {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
        }
    </style>

</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4 py-2">
        <a class="navbar-brand fs-4 me-4" href="#">📞 CRM Dialer</a>

        <div class="collapse navbar-collapse w-100">
            <div class="d-flex flex-wrap align-items-center gap-2 me-auto" style="flex: 1 1 auto;">

                <input id="phoneInput" type="text" class="form-control form-control-sm" placeholder="Enter mobile number" style="max-width: 200px;" />


                <div id="dialGroup" class="d-flex align-items-center gap-2" style="display: none !important;">
                    <button class="btn btn-success btn-sm" onclick="makeCall()">📞 Call</button>
                </div>


                <div id="onCallGroup" class="d-flex align-items-center gap-2" style="display: none !important;">
                    <button class="btn btn-warning btn-sm" onclick="callAPI('/api/Genesys/hold')">⏸ Hold</button>
                    <button class="btn btn-info btn-sm" onclick="callAPI('/api/Genesys/unhold')">▶ Unhold</button>
                    <button class="btn btn-secondary btn-sm" onclick="openConferencePrompt()">👥 Conference</button>
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/merge')">Merge</button>
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/party')">Party Delete</button>
                    <select class="form-select form-select-sm" style="min-width: 130px;" onchange="sendTransfer(this.value)">
                        <option disabled selected>⏬ Select route</option>
                        <option value="3000002">3000002</option>
                    </select>
                </div>


                <div id="breakGroup" class="d-flex align-items-center gap-2" style="display: none !important;">
                    <select class="form-select form-select-sm" style="min-width: 130px;" onchange="sendBreak(this.value)">
                        <option disabled selected>⏬ Select Reason</option>
                        <option value="5">🍵 Tea</option>
                        <option value="6">🍽 Lunch</option>
                        <option value="7">📘 Training</option>
                        <option value="8">🕵️ Quality</option>
                        <option value="9">🚻 Bio</option>
                        <option value="26">🧑‍💼 TL Feedback</option>
                    </select>
                </div>


                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/ready')">🕵️ Ready</button>
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/GetNext')">🕵️ GetNext</button>
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/disconnect')">❌ Disconnect</button>
                    <button class="btn btn-dark btn-sm" onclick="callAPI('/api/Genesys/LogOut')">🕵️ Log-Out</button>
                </div>
            </div>

            <div class="ms-4 p-3 rounded bg-dark d-flex flex-column align-items-end shadow" style="min-width: 180px;">
                <span id="username" class="text-light fw-bold fs-5">Agent Name</span>
                <span id="status" class="badge bg-warning text-dark fs-6 mt-1">Status</span>
                <span id="callTimer" class="text-light fw-bold fs-5 mt-2">00:00</span>
            </div>
        </div>
    </nav>


    <div class="ms-4 p-3 rounded bg-light shadow" style="min-width: 100px;" id="attachedDataContainer">
        <h6 class="text-dark mb-2">📄 Capturing Data</h6>

        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: nowrap;">
            <label for="disposition" style="margin: 0;">Disposition:</label>
            <select id="disposition" onchange="updateSubDisposition()" style="width: 150px;">
                <option value="">-- Select Disposition --</option>
                <option value="1">Call Back</option>
                <option value="2">Disconnect</option>
                <option value="3">Busy</option>
            </select>

            <label for="subDisposition" style="margin: 0;">Sub-Dispo:</label>
            <select id="subDisposition" style="width: 180px;">
                <option value="">-- Select Sub Disposition --</option>
            </select>

            <button style="width: 119px; margin-right: 613px; " onclick="submitDisposition()" class="btn btn-primary ms-auto">Submit</button>
        </div>
    </div>


    <div class="ms-4 p-3 rounded bg-light shadow" style="min-width: 200px;" id="attachedDataContainer">
        <h6 class="text-dark">📄 Attached Data</h6>
        <div id="attachedData" class="text-dark small"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/signalr.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let timerInterval = null;
        let seconds = 0;

        function startTimer() {
            stopTimer();
            seconds = 0;
            console.log("Starting call timer...");
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById("callTimer").innerText = formatTime(seconds);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                console.log(" Stopping call timer...");
                clearInterval(timerInterval);
                timerInterval = null;
                seconds = 0;
            }
            seconds = 0;
            document.getElementById("callTimer").innerText = "00:00";
        }

        function formatTime(sec) {
            const hours = Math.floor(sec / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
            const seconds = (sec % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('empCode');

            if (!agentId) {
                console.error("Agent ID (empCode) is missing in the URL.");
                return;
            }

            let timerInterval = null;
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/ctihub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.onreconnecting((error) => {
                console.warn(" SignalR reconnecting...", error);
                const statusElem = document.getElementById("status");

            });
            connection.on("UpdatePhoneInput", function (number) {
                let last10 = number.substring(number.length - 10);
                console.log(last10);
                document.getElementById("phoneInput").value = last10;
                ;
            });
            connection.on("UserName", function (number) {


                document.getElementById("username").innerText = number;

            });
            connection.onreconnected((connectionId) => {
                console.info("✅ SignalR reconnected:", connectionId);
                connection.invoke("JoinGroup", agentId)
                    .then(() => console.log("Rejoined group after reconnect"))
                    .catch(err => console.error("Error rejoining group:", err));
            });

            connection.onclose((error) => {
                console.error(" SignalR connection closed permanently:", error);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = "Disconnected. Please refresh the page.";
            });

            connection.on("ReceiveStatus", function (message) {
                console.log("Status message received:", message);
                const statusElem = document.getElementById("status");
                statusElem.innerText = message;
                const msg = message.toLowerCase();
                $("#dialGroup").hide();
                $("#onCallGroup").hide();
                $("#breakGroup").hide();

                if (msg.includes("waiting")) {
                    $("#breakGroup").css("display", "flex");
                    $("#dialGroup").css("display", "flex");
                    $("#onCallGroup").attr("style", "display: none !important;");
                }
                else if (
                    msg.includes("talking") ||
                    msg.includes("established") ||
                    msg.includes("outbound call established") ||
                    msg.includes("inbound call established")
                ) {
                    $("#onCallGroup").css("display", "flex");
                    $("#dialGroup").attr("style", "display: none !important;");
                    $("#breakGroup").attr("style", "display: none !important;");
                }

                else if (msg.includes("wraping")) {
                    $("#dialGroup").css("display", "flex");
                    $("#onCallGroup").attr("style", "display: none !important;");

                }

                else {
                }
                if (
                    msg.includes("talking") ||
                    msg.includes("wraping") ||
                    msg.includes("waiting") ||
                    msg.includes("established") ||
                    msg.includes("outbound call established") ||
                    msg.includes("inbound call established")
                ) {
                    stopTimer();
                    startTimer();
                }
                else if (
                    msg.includes("call ended") ||
                    msg.includes("disconnected") ||
                    msg.includes("hangup") ||
                    msg.includes("idle")
                ) {
                    stopTimer();
                }

                if (
                    msg.includes("break")

                ) {
                    stopTimer();
                    startTimer();
                }

            });

            connection.on("ReceiveAttachedData", function (data) {
                console.log(" Attached Data received:", data);
                const container = document.getElementById("attachedData");
                container.innerHTML = "";

                if (data && typeof data === "object") {
                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const row = document.createElement("div");
                            row.innerHTML = `<strong>${key}:</strong> ${data[key]}`;
                            container.appendChild(row);
                        }
                    }
                }
            });

            async function startConnection() {
                try {
                    await connection.start();
                    console.log(" SignalR connected");

                    await connection.invoke("JoinGroup", agentId);
                    await updateSatus();
                    startTimer();
                } catch (err) {
                    console.error("SignalR connection error:", err);
                    setTimeout(startConnection, 5000);
                }
            }
            startConnection();

        });

        async function updateSatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('empCode');

            if (!agentId) {
                console.error("No agent ID found in URL.");
                return;
            }
            try {
                const response = await fetch('/api/Genesys/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ empCode: agentId })
                });
            } catch (err) {
                console.error("Failed to get agent status:", agentId);
            }
        }
    </script>


    <script>
        function callAPI(url, method = 'POST', data = {}) {
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(async res => {
                    if (!res.ok) {
                        const errorText = await res.text();
                        if (errorText ==="Agent ready for next call.") {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: errorText ,
                            });
                        }
                        else {
                            throw new Error(errorText || "API call failed");
                        }
                        
                    } else {
                        console.log("✅ API call successful.");
                    }
                })
                .catch(err => {
                    console.error("🚨 API Error:", err.message);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Oops...',
                        text: err.message || "Something went wrong!",
                    });
                });
        }

        function makeCall() {
            const phone = document.getElementById("phoneInput").value.trim();

            if (!phone) {
                alert("Please enter a number");
                return;
            }

            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phone)) {
                alert("Phone number must be exactly 10 digits and contain only numbers.");
                return;
            }

            callAPI("/api/Genesys/makecall", "POST", { phone });
        }


        function openConferencePrompt() {
            Swal.fire({
                title: 'Enter conference number',
                input: 'text',
                inputPlaceholder: 'e.g. 7058053821',
                showCancelButton: true,
                confirmButtonText: 'Join',
                inputValidator: (value) => {
                    if (!value) return 'You must enter a number!';
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(value)) {
                        return alert("Phone number must be exactly 10 digits and contain only numbers.");
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    callAPI('/api/Genesys/conference', 'POST', { number: result.value });
                }
            });
        }

        function sendBreak(reasonCode) {
            callAPI('/api/Genesys/break', 'POST', { reasonCode });
        }

        function sendTransfer(route) {
            callAPI('/api/Genesys/transfer', 'POST', { route });
        }
    </script>

</body>
</html>


<script>
    const subDispositions = {
        1: [
            { id: 101, name: "Not Available" },
            { id: 102, name: "Client Requested" },
            { id: 103, name: "Wrong Time" }
        ],
        2: [
            { id: 201, name: "Customer Hung Up" },
            { id: 202, name: "Agent Hung Up" },
            { id: 203, name: "Network Issue" }
        ],
        3: [
            { id: 301, name: "Customer Busy" },
            { id: 302, name: "On Another Call" },
            { id: 303, name: "Will Call Later" }
        ]
    };

    function updateSubDisposition() {
        const dispoId = document.getElementById("disposition").value;
        const subDispoSelect = document.getElementById("subDisposition");

        subDispoSelect.innerHTML = '<option value="">-- Select Sub Disposition --</option>';

        if (subDispositions[dispoId]) {
            subDispositions[dispoId].forEach(sub => {
                const option = document.createElement("option");
                option.value = sub.id;
                option.textContent = sub.name;
                subDispoSelect.appendChild(option);
            });
        }
    }

    async function submitDisposition() {
        const dispoId = parseInt(document.getElementById("disposition").value);
        const subDispoId = parseInt(document.getElementById("subDisposition").value);

        if (!dispoId || !subDispoId) {
            alert("Please select both disposition and sub-disposition.");
            return;
        }

        try {
            const response = await fetch('/api/Genesys/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dispositionId: dispoId,
                    subDispositionId: subDispoId
                })
            });

            if (response.ok) {
                const result = await response.json();
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.message
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to submit disposition.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Exception',
                text: error?.message || 'An unexpected error occurred.'
            });
        }
    }
</script>