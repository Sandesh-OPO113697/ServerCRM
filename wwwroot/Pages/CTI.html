<!DOCTYPE html>
<html>
<head>
    <title>CRM Dialer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/signalr.min.js"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4">
        <a class="navbar-brand" href="#">📞 CRM Dialer</a>

        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 d-flex align-items-center gap-2">

                <li class="nav-item d-flex align-items-center">
                    <input id="phoneInput" type="text" class="form-control form-control-sm" placeholder="Enter mobile number" />
                    <button class="btn btn-success btn-sm" id="call_button" onclick="makeCall()">📞 Call</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-warning btn-sm" id="hold_button" onclick="callAPI('/api/Genesys/hold')">⏸ Hold</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-info btn-sm"  id="unhold_button" onclick="callAPI('/api/Genesys/unhold')">▶ Unhold</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-secondary btn-sm"  id="conference_button" onclick="openConferencePrompt()">👥 Conference</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-dark btn-sm" id="merge_button"  onclick="callAPI('/api/Genesys/merge')">Merge</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-dark btn-sm"id="party_button"  onclick="callAPI('/api/Genesys/party')">Party Delete</button>
                </li>

                <li class="nav-item">
                    <button class="btn btn-dark btn-sm" id="dissconnect_button" onclick="callAPI('/api/Genesys/disconnect')">❌ Disconnect</button>
                </li>

                <li class="nav-item">
                    <select class="form-select form-select-sm" id="break_button" onchange="sendBreak(this.value)">
                        <option disabled selected>⏬ Select Reason</option>
                        <option value="5">🍵 Tea</option>
                        <option value="6">🍽 Lunch</option>
                        <option value="7">📘 Training</option>
                        <option value="8">🕵️ Quality</option>
                        <option value="9">🚻 Bio</option>
                        <option value="26">🧑‍💼 TL Feedback</option>
                    </select>
                </li>

                <li class="nav-item">
                    <button class="btn btn-dark btn-sm" id="ready_button" onclick="callAPI('/api/Genesys/ready')">🕵️ Ready</button>
                </li>

                <li class="nav-item">
                    <select class="form-select form-select-sm" id="transfer_button" onchange="sendTransfer(this.value)">
                        <option disabled selected>⏬ Select route</option>
                        <option value="2000003">2000003</option>
                    </select>
                </li>

            </ul>

            <div class="ms-4 p-3 rounded bg-dark d-flex flex-column align-items-end shadow-lg" style="min-width: 200px;">
                <div>
                    <span id="status" class="badge bg-warning text-dark fs-6">...</span>
                </div>
                <span id="callTimer" class="mt-2 text-light fw-bold fs-5">00:00</span>

            </div>

        </div>
    </nav>

    <div class="ms-4 p-3 rounded bg-light shadow" style="min-width: 200px;" id="attachedDataContainer">
        <h6 class="text-dark">📄 Attached Data</h6>
        <div id="attachedData" class="text-dark small"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/signalr.min.js"></script>
    <script>
        let timerInterval = null;
        let seconds = 0;

        function startTimer() {
            stopTimer();
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById("callTimer").innerText = formatTime(seconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            document.getElementById("callTimer").innerText = "";
        }

        function formatTime(sec) {
            const minutes = Math.floor(sec / 60).toString().padStart(2, '0');
            const seconds = (sec % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('empCode');

            if (!agentId) {
                console.error("Agent ID (empCode) is missing in the URL.");
                return;
            }

            let timerInterval = null;

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/ctihub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.onreconnecting((error) => {
                console.warn("🔌 SignalR reconnecting...", error);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = "Reconnecting...";
            });

            connection.onreconnected((connectionId) => {
                console.info("✅ SignalR reconnected:", connectionId);
                connection.invoke("JoinGroup", agentId)
                    .then(() => console.log("Rejoined group after reconnect"))
                    .catch(err => console.error("Error rejoining group:", err));
            });

            connection.onclose((error) => {
                console.error("❌ SignalR connection closed permanently:", error);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = "Disconnected. Please refresh the page.";
            });

            connection.on("ReceiveStatus", function (message) {
                console.log("📥 Status message received:", message);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = message;

                const msg = message.toLowerCase();

                if (
                    msg.includes("talking") ||
                    msg.includes("established") ||
                    msg.includes("outbound call established") ||
                    msg.includes("inbound call established")
                ) {
                    startTimer();
                } else if (
                    msg.includes("call ended") ||
                    msg.includes("disconnected") ||
                    msg.includes("hangup") ||
                    msg.includes("already on call") ||
                    msg.includes("abandoned") ||
                    msg.includes("out of service") ||
                    msg.includes("destination is busy")
                ) {
                    stopTimer();
                }
            });

            connection.on("ReceiveAttachedData", function (data) {
                console.log("📥 Attached Data received:", data);
                const container = document.getElementById("attachedData");
                container.innerHTML = "";

                if (data && typeof data === "object") {
                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const row = document.createElement("div");
                            row.innerHTML = `<strong>${key}:</strong> ${data[key]}`;
                            container.appendChild(row);
                        }
                    }
                }
            });

            async function startConnection() {
                try {
                    await connection.start();
                    console.log("✅ SignalR connected");
                    await connection.invoke("JoinGroup", agentId);
                } catch (err) {
                    console.error("SignalR connection error:", err);
                    setTimeout(startConnection, 5000);
                }
            }

            startConnection();

            function startTimer() {
                if (!timerInterval) {
                    console.log("🕒 Starting call timer...");
                    timerInterval = setInterval(() => {
                    }, 1000);
                }
            }

            function stopTimer() {
                if (timerInterval) {
                    console.log("⏹️ Stopping call timer...");
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }
        });
    </script>

    <!--<script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('empCode');

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/ctihub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();
            connection.onreconnecting((error) => {
                console.warn("🔌 SignalR reconnecting...", error);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = "Reconnecting...";
            });

            connection.onreconnected((connectionId) => {
                console.info("✅ SignalR reconnected:", connectionId);
                connection.invoke("JoinGroup", agentId)
                    .then(() => console.log("Rejoined group after reconnect"))
                    .catch(err => console.error("Error rejoining group:", err));
            });
            connection.onclose((error) => {
                console.error("❌ SignalR connection closed permanently:", error);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = "Disconnected. Please refresh the page.";
            });
            connection.on("ReceiveStatus", function (message) {
                console.log("Status message received:", message);
                const statusElem = document.getElementById("status");
                if (statusElem) statusElem.innerText = message;

                const messageLower = message.toLowerCase();

                if (
                    messageLower.includes("talking") ||
                    messageLower.includes("established") ||
                    messageLower.includes("outbound call established") ||
                    messageLower.includes("inbound call established")

                ) {
                    startTimer();
                }
                else if (
                    messageLower.includes("call ended") ||
                    messageLower.includes("disconnected") ||
                    messageLower.includes("hangup") ||
                    messageLower.includes("already on call") ||
                    messageLower.includes("abandoned") ||
                    messageLower.includes("out of service") ||
                    messageLower.includes("destination is busy")
                ) {
                    stopTimer();
                }
            });





            connection.start()
                .then(() => connection.invoke("JoinGroup", agentId))
                .catch(err => console.error("SignalR Error:", err));


            connection.on("ReceiveAttachedData", function (data) {
                console.log("Attached Data received:", data);

                const container = document.getElementById("attachedData");
                container.innerHTML = ""; // Clear previous data

                if (data && typeof data === "object") {
                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const row = document.createElement("div");
                            row.innerHTML = `<strong>${key}:</strong> ${data[key]}`;
                            container.appendChild(row);
                        }
                    }
                }
            });

        });





    </script>-->
    <script>




        function callAPI(url, method = 'POST', data = {}) {
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(res => {
                if (!res.ok) throw new Error("API failed");
            }).catch(err => {
                console.error(err);
                alert("Something went wrong");
            });
        }

        function makeCall() {
            const phone = document.getElementById("phoneInput").value;
            if (!phone) return alert("Please enter a number");
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phone)) {
                return alert("Phone number must be exactly 10 digits and contain only numbers.");
            }
            callAPI("/api/Genesys/makecall", 'POST', { phone });
        }

        function openConferencePrompt() {
            Swal.fire({
                title: 'Enter conference number',
                input: 'text',
                inputPlaceholder: 'e.g. 7058053821',
                showCancelButton: true,
                confirmButtonText: 'Join',
                inputValidator: (value) => {
                    if (!value) return 'You must enter a number!';
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(value)) {
                        return alert("Phone number must be exactly 10 digits and contain only numbers.");
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    callAPI('/api/Genesys/conference', 'POST', { number: result.value });
                }
            });
        }

        function sendBreak(reasonCode) {
            callAPI('/api/Genesys/break', 'POST', { reasonCode });
        }

        function sendTransfer(route) {
            callAPI('/api/Genesys/transfer', 'POST', { route });
        }
    </script>

</body>
</html>
